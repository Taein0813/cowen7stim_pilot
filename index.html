<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Cowen7 감정 실험</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ✅ 로컬 jsPsych 파일 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />
  <script src="./jspsych/jspsych.js"></script>
  <script src="./jspsych/plugins/jspsych-preload.js"></script>
  <script src="./jspsych/plugins/jspsych-html-button-response.js"></script>
  <script src="./jspsych/plugins/jspsych-survey-html-form.js"></script>

  <style>
    body { max-width: 980px; margin: 0 auto; padding: 24px; font-family: sans-serif; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; font-size:12px; }
    .muted { color:#666; font-size: 0.9rem; }
    .note { background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:8px; }
    .pair-wrap { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 12px; }
    .audio-card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; }
    .audio-card .label { font-weight: 800; font-size: 1rem; }
    audio { width: 100%; height: 40px; }
    .jspsych-content h3:first-of-type { position: sticky; top: 0; background: #fff; padding: 8px 0; z-index: 20; border-bottom: 1px solid #eee; }
    #jspsych-html-button-response-btngroup { position: sticky; bottom: 0; background: rgba(255,255,255,0.96); backdrop-filter: saturate(140%) blur(6px); padding: 12px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: space-between; z-index: 30; }
    .jspsych-btn { flex: 1; padding: 14px 16px; border-radius: 999px; font-size: 1.05rem; }
    .jspsych-content { max-width: 720px; margin: 0 auto; }
    @media (min-width: 1024px){
      .pair-wrap { grid-template-columns: 1fr 1fr; }
      #jspsych-html-button-response-btngroup { position: static; backdrop-filter: none; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target">로딩 중...</div>

<script>
/***********************
 * 사용자 설정
 ***********************/
const ROOT = "./Cowen7";

const EMOTIONS = [
  { key: 'energetic', label_ko: '에너지가 넘치는', label_en: 'energetic' },
  { key: 'tense',     label_ko: '불안한',         label_en: 'tense' },
  { key: 'cheerful',  label_ko: '즐거운',         label_en: 'cheerful' },
  { key: 'dreamy',    label_ko: '꿈꾸는 듯한',     label_en: 'dreamy' },
  { key: 'calm',      label_ko: '평온한',         label_en: 'calm' },
  { key: 'sad',       label_ko: '슬픈',           label_en: 'sad' },
  { key: 'love',      label_ko: '사랑에 빠진',     label_en: 'in love' },
];

const EXT = "mp3";
const COUNT = 10;
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyowrSqY3hw71XR7qIqzAHyhm4iUnh27x-Q9qW3zmvboKudPemd3OQLLIaIs2SmX0XP/exec";

/***********************
 * jsPsych init
 ***********************/
const jsPsych = initJsPsych({ display_element: "jspsych-target" });
const timeline = [];

/***********************
 * 참가자 정보
 ***********************/
timeline.push({
  type: jsPsychSurveyHtmlForm,
  preamble: `<h2>참가자 정보</h2>`,
  html: `
    <label>참가자 ID *</label><br>
    <input name="pid" type="text" required style="width:260px;padding:6px;"><br><br>
    <label>기기</label><br>
    <select name="device" style="width:260px;padding:6px;">
      <option>모바일(iOS)</option>
      <option>모바일(Android)</option>
      <option>데스크탑</option>
    </select>
    <div class="note" style="margin-top:8px;">상은 <b>최대 5개 권장</b>입니다.</div>
  `,
  button_label: "시작하기",
  on_finish: d => {
    const r = JSON.parse(d.response);
    jsPsych.data.addProperties({ pid: r.pid, device: r.device });
  }
});

/***********************
 * 안내문
 ***********************/
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>감정별 상/중/하 분류 실험</h2>
    <div class="note">
      <ul>
        <li>각 곡은 원하는 만큼 재생 가능합니다.</li>
        <li>상은 최대 5개 권장입니다(강제 아님).</li>
        <li>총 7개 감정 페이지로 구성되어 있습니다.</li>
      </ul>
    </div>
  `,
  choices: ["시작"]
});

/***********************
 * 감정별 블록
 ***********************/
function buildBlock(emotion){
  const paths = Array.from({length:COUNT},(_,i)=>`${ROOT}/${emotion.key}/${emotion.key}${i+1}.${EXT}`);

  const preload = { type: jsPsychPreload, audio: paths };

  const trial = {
    type: jsPsychHtmlButtonResponse,
    stimulus: () => {
      const others = EMOTIONS.filter(e=>e.key!==emotion.key).map(e=>e.label_ko).join(", ");
      const items = paths.map((p,i)=>`
        <div class="audio-card" data-id="${i}">
          <div class="note">
            <ul>
              <li>“<b>${emotion.label_ko}</b>” 감정에 잘 맞는가?</li>
              <li>이 곡을 들었을 때 다른 감정(<b>${others}</b>) 6개와 헷갈리지 않고 <b>${emotion.label_ko}</b>을 선택할 수 있어야 함</li>
            </ul>
          </div>
          <div class="label">${i+1}. ${p.split("/").pop()}</div>
          <audio src="${p}" controls preload="auto" playsinline></audio>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button class="jspsych-btn bucket" data-bucket="TOP">상</button>
            <button class="jspsych-btn bucket" data-bucket="MID">중</button>
            <button class="jspsych-btn bucket" data-bucket="LOW">하</button>
            <span class="muted" style="margin-left:auto;">선택: <span class="chosen">없음</span></span>
          </div>
        </div>`).join("");

      return `
        <h3>카테고리: ${emotion.label_ko} (${emotion.label_en})</h3>
        <p class="muted">상은 최대 5개 권장</p>
        <div class="pair-wrap">${items}</div>`;
    },
    choices: ["분류 완료"],
    on_load: () => {
      const sel = {}; let topCount = 0;
      document.body.addEventListener("click", e=>{
        const b = e.target.closest("button.bucket");
        if(!b) return;
        const card = b.closest(".audio-card");
        const id = Number(card.dataset.id);
        const prev = sel[id];
        if(prev==="TOP") topCount--;
        sel[id] = b.dataset.bucket;
        if(b.dataset.bucket==="TOP") topCount++;
        card.querySelector(".chosen").textContent = b.textContent;
      });
      window._sel = sel;
    },
    on_finish: async () => {
      const data = Object.entries(window._sel).map(([id,b])=>({id,bucket:b}));
      jsPsych.data.write({ emotion: emotion.key, allocations: data });
      await fetch(GS_WEBAPP_URL, {method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({kind:"cowen7_likert_block", emotion:emotion.key, allocations:data})});
    }
  };

  return [preload, trial];
}

EMOTIONS.forEach(e => timeline.push(...buildBlock(e)));

/***********************
 * 종료화면
 ***********************/
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `<h2>감사합니다!</h2><p>결과가 저장되었습니다.</p>`,
  choices: ["CSV 다운로드"],
  on_finish: () => {
    const blob = new Blob([jsPsych.data.get().csv()],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `cowen7_${Date.now()}.csv`;
    a.click();
  }
});

jsPsych.run(timeline);
</script>
</body>
</html>
