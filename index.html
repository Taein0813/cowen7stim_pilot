<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Cowen7 감정 실험 (5점 척도)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPsych CSS (원하면 로컬로 교체 가능) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />

  <!-- ✅ 로컬 jsPsych 스크립트 -->
  <script src="./jspsych/jspsych.js"></script>
  <script src="./jspsych/plugins/jspsych-html-button-response.js"></script>

  <style>
    body { max-width: 980px; margin: 0 auto; padding: 24px; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .note { background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:8px; }
    .pair-wrap { display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px; }
    .audio-card { border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
    .muted { color:#666; font-size:0.9rem; }
    audio { width:100%; height:40px; }
    .scale { display:flex; align-items:center; gap:6px; margin-top:8px; }
    .scale .label { white-space:nowrap; }
    .scale .nums { display:flex; gap:4px; flex:1; justify-content:space-between; }
    .scale .nums button { flex:1; border:1px solid #d1d5db; border-radius:6px; padding:8px 0; background:#fff; }
    .scale .nums button.selected { background:#2563eb; color:#fff; font-weight:600; border-color:#2563eb; }
    .fatal { background:#fff1f2; color:#b91c1c; border:1px solid #fecdd3; padding:12px; border-radius:10px; }
    .jspsych-content { max-width: 720px; margin: 0 auto; }
    @media (min-width: 1024px){
      .pair-wrap { grid-template-columns: 1fr 1fr; }
      #jspsych-html-button-response-btngroup { position: static; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

<script>
/* 전역 에러 캡처: 에러 발생 시 화면에 원인 표시 */
window.addEventListener('error', (e)=>{
  const m = document.getElementById('jspsych-target');
  if(m){
    m.innerHTML = '<div class="fatal"><b>오류:</b> '+ (e?.error?.message || e.message) + '</div>';
  }
});

/* 로드 확인 */
(function(){
  const mount = document.getElementById('jspsych-target');
  function fatal(msg){ mount.innerHTML = '<div class="fatal"><b>오류:</b> '+msg+'</div>'; throw new Error(msg); }
  if(typeof initJsPsych !== 'function') fatal('jsPsych 로드 실패 (./jspsych/jspsych.js 확인).');
  if(typeof jsPsychHtmlButtonResponse !== 'function') fatal('플러그인 로드 실패: jsPsychHtmlButtonResponse.');
})();

/* ===== 설정 ===== */
const ROOT = "./Cowen7";
const EMOTIONS = [
  { key:'energetic', label_ko:'에너지가 넘치는', label_en:'energetic' },
  { key:'tense',     label_ko:'불안한',         label_en:'tense' },
  { key:'cheerful',  label_ko:'즐거운',         label_en:'cheerful' },
  { key:'dreamy',    label_ko:'꿈꾸는 듯한',     label_en:'dreamy' },
  { key:'calm',      label_ko:'평온한',         label_en:'calm' },
  { key:'sad',       label_ko:'슬픈',           label_en:'sad' },
  { key:'love',      label_ko:'사랑에 빠진',     label_en:'in love' },
];
const EXT = "mp3";
const COUNT = 10;
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyowrSqY3hw71XR7qIqzAHyhm4iUnh27x-Q9qW3zmvboKudPemd3OQLLIaIs2SmX0XP/exec";

/* 참가자 관련 전역 (롱 포맷용) */
let PARTICIPANT_GROUP = null;
let PARTICIPANT_ID = `P${Date.now()}_${Math.floor(Math.random()*1e6)}`;
let ALL_ROWS = [];

/* ===== jsPsych ===== */
const jsPsych = initJsPsych({ display_element: "jspsych-target" });
jsPsych.data.addProperties({ participant_id: PARTICIPANT_ID });

const timeline = [];

/* ===== 전공 여부 질문 (수정사항3) ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>간단한 질문</h2>
    <p>아래에서 본인의 전공 여부를 선택해 주세요.</p>
  `,
  choices: ["음악 전공", "음악 비전공"],
  on_finish: (data) => {
    const group = data.response === 0 ? "music_major" : "non_music_major";
    PARTICIPANT_GROUP = group;
    jsPsych.data.addProperties({ participant_group: group });
  }
});

/* ===== 안내 ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>감정별 5점 척도 평가 실험</h2>
    <div class="note">
      <ul style="margin:0 0 8px 16px;">
        <li>감정 순서는 무작위입니다. 각 감정마다 10곡이 제시됩니다.</li>
        <li>각 곡은 원하는 만큼 재생할 수 있습니다.</li>
        <li>각 곡이 해당 감정에 <b>얼마나 적절한지</b> 1~5점으로 평가해 주세요.</li>
        <li>(<b>1=부적절함</b> … <b>5=적절함</b>)</li>
      </ul>
    </div>
  `,
  choices: ["시작하기"]
});

/* ===== 감정 블록 (5점 척도) ===== */
function buildBlock(emotion){
  const paths = Array.from({length:COUNT},(_,i)=>`${ROOT}/${emotion.key}/${emotion.key}${i+1}.${EXT}`);

  return [{
    type: jsPsychHtmlButtonResponse,
    data: { emotion: emotion.key },          // ✅ 이후 addToLast로 병합
    stimulus: () => {
      const others = EMOTIONS
        .filter(e => e.key !== emotion.key)
        .map(e => `'${e.label_ko}'`)
        .join(", ");
      const items = paths.map((p,i)=>`
        <div class="audio-card" data-id="${i}">
          <div class="note">
            <p style="margin:0 0 4px 0;"><b>&lt;판단 기준&gt;</b></p>
            <ol style="margin:0 0 0 16px; padding-left:16px;">
              <li>“<b>${emotion.label_ko}</b>” 감정을 잘 표현하고 있는가?</li>
              <li>이 곡을 들었을 때 다른 감정(${others}) 6개와 헷갈리지 않고 '<b>${emotion.label_ko}</b>'를 선택할 수 있을 만한가?</li>
            </ol>
          </div>
          <div><b>${i+1}. ${p.split("/").pop()}</b></div>
          <audio src="${p}" controls preload="metadata" playsinline></audio>
          <div class="scale" role="group" aria-label="적절성 5점 척도">
            <span class="label muted">(부적절함)</span>
            <div class="nums">
              ${[1,2,3,4,5].map(v=>`<button class="score" data-score="${v}" type="button">${v}</button>`).join('')}
            </div>
            <span class="label muted">(적절함)</span>
          </div>
        </div>`).join("");

      return `<h3>${emotion.label_ko} <span class="muted">(${emotion.label_en})</span></h3>
              <p class="muted" id="remain">미평가 곡: ${COUNT}</p>
              <div class="pair-wrap" id="pair-wrap">${items}</div>`;
    },
    choices: ["평가 완료"],
    on_load: () => {
      const wrap     = document.getElementById('pair-wrap');   // ✅ 컨테이너 단위 바인딩 (누적/충돌 방지)
      const btnGroup = document.getElementById('jspsych-html-button-response-btngroup');
      const doneBtn  = btnGroup ? btnGroup.querySelector('button') : null;
      const remainEl = document.getElementById('remain');
      const sel = {};  // id -> score

      function updateButton(){
        const remain = COUNT - Object.keys(sel).length;
        if(remainEl) remainEl.textContent = `미평가 곡: ${remain}`;
        if(doneBtn){
          doneBtn.disabled = remain > 0;
          doneBtn.textContent = remain > 0 ? `평가 완료 (남은 ${remain})` : '평가 완료';
        }
      }
      updateButton();

      // 점수 클릭 (컨테이너 위임)
      wrap.addEventListener('click', (e)=>{
        const b = e.target.closest('button.score');
        if(!b) return;
        const card = b.closest('.audio-card');
        const id = Number(card.dataset.id);
        const score = Number(b.dataset.score);
        sel[id] = score;
        // 선택 표시 토글
        card.querySelectorAll('button.score').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
        updateButton();
      }, { passive:true });

      // 동시에 재생 방지
      const auds = Array.from(wrap.querySelectorAll('audio'));
      auds.forEach(A=>A.addEventListener('play', ()=>auds.forEach(B=>{ if(B!==A && !B.paused) B.pause(); })));

      // 다음 단계에서 읽기
      window.__currentSel = sel;
    },
    on_finish: () => {
      const data = Object.entries(window.__currentSel||{}).map(([id,s])=>({id:Number(id),score:s}));

      /* ===== 롱 포맷 row 생성 (수정사항2) ===== */
      const rows = data.map(({id, score}) => {
        const filePath = paths[id];
        const fileName = filePath.split("/").pop();
        return {
          participant_id: PARTICIPANT_ID,
          participant_group: PARTICIPANT_GROUP,
          emotion_key: emotion.key,
          emotion_label_ko: emotion.label_ko,
          file_path: filePath,
          file_name: fileName,
          index_in_emotion: id + 1,
          score: score
        };
      });

      // jsPsych 마지막 trial에 병합 저장
      jsPsych.data.get().addToLast({
        allocations: data,
        rows: rows
      });

      // 전체 rows 전역 누적
      ALL_ROWS = ALL_ROWS.concat(rows);

      // 블록 단위 업로드 (옵션, fire-and-forget)
      try{
        fetch(GS_WEBAPP_URL, {
          method:"POST", mode:"no-cors",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            kind:"cowen7_rating_block_long",
            emotion: emotion.key,
            participant_id: PARTICIPANT_ID,
            participant_group: PARTICIPANT_GROUP,
            rows: rows
          })
        });
      }catch(e){ /* 무시 */ }
    }
  }];
}

/* 감정 순서 무작위 */
const order = EMOTIONS.slice().sort(()=>Math.random()-0.5);
order.forEach(e => timeline.push(...buildBlock(e)));

/* ===== 종료 ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `<h2>감사합니다!</h2><p>결과가 저장되었습니다.</p>`,
  choices: ["닫기"],
  on_finish: () => {
    // 전체 롱 포맷 백업 (fire-and-forget, 수정사항2)
    try{
      fetch(GS_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          kind: "cowen7_rating_full_long",
          participant_id: PARTICIPANT_ID,
          participant_group: PARTICIPANT_GROUP,
          rows: ALL_ROWS
        })
      });
    } catch(e) {
      console.warn("업로드 실패(무시 가능):", e);
    }
  }
});


jsPsych.run(timeline);
</script>
</body>
</html>
