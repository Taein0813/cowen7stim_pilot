<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Cowen7 감정 실험 (5점 척도)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />
  <!-- 로컬 jsPsych -->
  <script src="./jspsych/jspsych.js"></script>
  <script src="./jspsych/plugins/jspsych-html-button-response.js"></script>
  <style>
    body { max-width: 980px; margin: 0 auto; padding: 24px; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .note { background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:8px; }
    .pair-wrap { display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px; }
    .audio-card { border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
    audio { width:100%; height:40px; }
    .jspsych-btn { flex:1; padding:14px 16px; border-radius:999px; font-size:1.05rem; }
    .scale { display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:4px; }
    .scale button { flex:1; border:1px solid #d1d5db; border-radius:6px; padding:8px 0; background:#fff; }
    .scale button.selected { background:#2563eb; color:white; font-weight:600; }
    .muted { color:#666; font-size:0.9rem; }
    .fatal { background:#fff1f2; color:#b91c1c; border:1px solid #fecdd3; padding:12px; border-radius:10px; }
    @media (min-width: 1024px){
      .pair-wrap { grid-template-columns: 1fr 1fr; }
      #jspsych-html-button-response-btngroup { position: static; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

<script>
/* 전역 에러 캡처: 문제가 생기면 화면에 원인 표시 */
window.addEventListener('error', (e)=>{
  const m = document.getElementById('jspsych-target');
  if(m){
    m.innerHTML = '<div class="fatal"><b>오류:</b> '+ (e?.error?.message || e.message) + '</div>';
  }
});

/* 로드 확인 */
(function(){
  const mount = document.getElementById('jspsych-target');
  function fatal(msg){ mount.innerHTML = '<div class="fatal"><b>오류:</b> '+msg+'</div>'; throw new Error(msg); }
  if(typeof initJsPsych !== 'function') fatal('jsPsych 로드 실패 (./jspsych/jspsych.js 확인).');
  if(typeof jsPsychHtmlButtonResponse !== 'function') fatal('플러그인 로드 실패: jsPsychHtmlButtonResponse.');
})();

/* 설정 */
const ROOT = "./Cowen7";
const EMOTIONS = [
  { key:'energetic', label_ko:'에너지가 넘치는', label_en:'energetic' },
  { key:'tense',     label_ko:'불안한',         label_en:'tense' },
  { key:'cheerful',  label_ko:'즐거운',         label_en:'cheerful' },
  { key:'dreamy',    label_ko:'꿈꾸는 듯한',     label_en:'dreamy' },
  { key:'calm',      label_ko:'평온한',         label_en:'calm' },
  { key:'sad',       label_ko:'슬픈',           label_en:'sad' },
  { key:'love',      label_ko:'사랑에 빠진',     label_en:'in love' },
];
const EXT = "mp3";
const COUNT = 10;
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyowrSqY3hw71XR7qIqzAHyhm4iUnh27x-Q9qW3zmvboKudPemd3OQLLIaIs2SmX0XP/exec";

/* jsPsych */
const jsPsych = initJsPsych({ display_element: "jspsych-target" });
const timeline = [];

/* 안내 */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>감정별 5점 척도 평가 실험</h2>
    <div class="note">
      <ul style="margin:0 0 8px 16px;">
        <li>각 감정(무작위 순서)마다 10곡이 제시됩니다.</li>
        <li>각 곡은 원하는 만큼 재생할 수 있습니다.</li>
        <li>각 곡이 해당 감정에 <b>얼마나 적절한지</b> 1~5점으로 평가해 주세요.</li>
        <li>(1=부적절함, 5=적절함)</li>
      </ul>
    </div>
  `,
  choices: ["시작하기"]
});

/* 감정 블록 */
function buildBlock(emotion){
  const paths = Array.from({length:COUNT},(_,i)=>`${ROOT}/${emotion.key}/${emotion.key}${i+1}.${EXT}`);

  return [{
    type: jsPsychHtmlButtonResponse,
    stimulus: () => {
      const others = EMOTIONS.filter(e=>e.key!==emotion.key).map(e=>e.label_ko).join(", ");
      const items = paths.map((p,i)=>`
        <div class="audio-card" data-id="${i}">
          <div class="note">
            <ul style="margin:0 0 6px 16px;">
              <li>“<b>${emotion.label_ko}</b>” 감정에 잘 맞는가?</li>
              <li>이 곡을 들었을 때 다른 감정(<b>${others}</b>) 6개와 헷갈리지 않고 <b>${emotion.label_ko}</b>을 선택할 수 있어야 함</li>
            </ul>
          </div>
          <div><b>${i+1}. ${p.split("/").pop()}</b></div>
          <audio src="${p}" controls preload="metadata" playsinline></audio>
          <div class="scale" role="group" aria-label="적절성 5점 척도">
            <span class="muted">(부적절함)</span>
            ${[1,2,3,4,5].map(v=>`<button class="score" data-score="${v}" type="button">${v}</button>`).join('')}
            <span class="muted">(적절함)</span>
          </div>
        </div>`).join("");

      return `<h3>${emotion.label_ko} <span class="muted">(${emotion.label_en})</span></h3>
              <p class="muted" id="remain">미평가 곡: ${COUNT}</p>
              <div class="pair-wrap" id="pair-wrap">${items}</div>`;
    },
    choices: ["평가 완료"],
    on_load: () => {
      const wrap = document.getElementById('pair-wrap');        // ✅ 컨테이너에만 바인딩 (누적 방지)
      const btnGroup = document.getElementById('jspsych-html-button-response-btngroup');
      const doneBtn  = btnGroup ? btnGroup.querySelector('button') : null;
      const remainEl = document.getElementById('remain');
      const sel = {};  // id -> score

      function updateButton(){
        const remain = COUNT - Object.keys(sel).length;
        if(remainEl) remainEl.textContent = `미평가 곡: ${remain}`;
        if(doneBtn){
          doneBtn.disabled = remain > 0;
          doneBtn.textContent = remain > 0 ? `평가 완료 (남은 ${remain})` : '평가 완료';
        }
      }
      updateButton();

      // 점수 클릭(컨테이너 이벤트 위임)
      wrap.addEventListener('click', (e)=>{
        const b = e.target.closest('button.score');
        if(!b) return;
        const card = b.closest('.audio-card');
        const id = Number(card.dataset.id);
        sel[id] = Number(b.dataset.score);
        // 선택 표시 토글
        card.querySelectorAll('button.score').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
        updateButton();
      }, { passive:true });

      // 동시에 재생 방지
      const auds = Array.from(wrap.querySelectorAll('audio'));
      auds.forEach(A=>A.addEventListener('play', ()=>auds.forEach(B=>{ if(B!==A && !B.paused) B.pause(); })));

      // 다음 단계에서 읽을 수 있게 저장
      window.__currentSel = sel;
    },
      jsPsych.data.get().addToLast({ emotion: emotion.key, allocations: data });  // ✅ 안전
      // 업로드는 fire-and-forget
      try{
        fetch(GS_WEBAPP_URL, {
          method:"POST", mode:"no-cors",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ kind:"cowen7_rating_block", emotion:emotion.key, allocations:data })
        });
      }catch(e){ /* 무시 */ }
    }
  }];
}

/* 감정 순서 무작위 */
const order = EMOTIONS.slice().sort(()=>Math.random()-0.5);
order.forEach(e => timeline.push(...buildBlock(e)));

/* 종료 */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `<h2>감사합니다!</h2><p>결과가 저장되었습니다.</p>`,
  choices: ["CSV 다운로드", "닫기"],
  on_finish: (d) => {
    if(d.response === 0){
      const blob = new Blob([jsPsych.data.get().csv()],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `cowen7_${Date.now()}.csv`;
      a.click();
    }
    try{
      fetch(GS_WEBAPP_URL, {
        method:"POST", mode:"no-cors",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ kind:"cowen7_rating_full", data: jsPsych.data.get().values() })
      });
    }catch(e){ /* 무시 */ }
  }
});

jsPsych.run(timeline);
</script>
</body>
</html>
