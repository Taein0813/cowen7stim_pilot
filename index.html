<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Cowen7 ê°ì • ì‹¤í—˜ (5ì  ì²™ë„)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPsych CSS (ì›í•˜ë©´ ë¡œì»¬ë¡œ êµì²´ ê°€ëŠ¥) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />

  <!-- âœ… ë¡œì»¬ jsPsych ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="./jspsych/jspsych.js"></script>
  <script src="./jspsych/plugins/jspsych-html-button-response.js"></script>

  <style>
    body { max-width: 980px; margin: 0 auto; padding: 24px; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .note { background:#f8fafc; border:1px dashed #cbd5e1; padding:10px; border-radius:8px; }
    .pair-wrap { display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px; }
    .audio-card { border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
    .muted { color:#666; font-size:0.9rem; }
    audio { width:100%; height:40px; }
    .scale { display:flex; align-items:center; gap:6px; margin-top:8px; }
    .scale .label { white-space:nowrap; }
    .scale .nums { display:flex; gap:4px; flex:1; justify-content:space-between; }
    .scale .nums button { flex:1; border:1px solid #d1d5db; border-radius:6px; padding:8px 0; background:#fff; }
    .scale .nums button.selected { background:#2563eb; color:#fff; font-weight:600; border-color:#2563eb; }
    .fatal { background:#fff1f2; color:#b91c1c; border:1px solid #fecdd3; padding:12px; border-radius:10px; }
    .jspsych-content { max-width: 720px; margin: 0 auto; }
    @media (min-width: 1024px){
      .pair-wrap { grid-template-columns: 1fr 1fr; }
      #jspsych-html-button-response-btngroup { position: static; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

<script>
/* ì „ì—­ ì—ëŸ¬ ìº¡ì²˜: ì—ëŸ¬ ë°œìƒ ì‹œ í™”ë©´ì— ì›ì¸ í‘œì‹œ */
window.addEventListener('error', (e)=>{
  const m = document.getElementById('jspsych-target');
  if(m){
    m.innerHTML = '<div class="fatal"><b>ì˜¤ë¥˜:</b> '+ (e?.error?.message || e.message) + '</div>';
  }
});

/* ë¡œë“œ í™•ì¸ */
(function(){
  const mount = document.getElementById('jspsych-target');
  function fatal(msg){ mount.innerHTML = '<div class="fatal"><b>ì˜¤ë¥˜:</b> '+msg+'</div>'; throw new Error(msg); }
  if(typeof initJsPsych !== 'function') fatal('jsPsych ë¡œë“œ ì‹¤íŒ¨ (./jspsych/jspsych.js í™•ì¸).');
  if(typeof jsPsychHtmlButtonResponse !== 'function') fatal('í”ŒëŸ¬ê·¸ì¸ ë¡œë“œ ì‹¤íŒ¨: jsPsychHtmlButtonResponse.');
})();

/* ===== ì„¤ì • ===== */
const ROOT = "./Cowen7";
const EMOTIONS = [
  { key:'energetic', label_ko:'ì—ë„ˆì§€ê°€ ë„˜ì¹˜ëŠ”', label_en:'energetic' },
  { key:'tense',     label_ko:'ë¶ˆì•ˆí•œ',         label_en:'tense' },
  { key:'cheerful',  label_ko:'ì¦ê±°ìš´',         label_en:'cheerful' },
  { key:'dreamy',    label_ko:'ê¿ˆê¾¸ëŠ” ë“¯í•œ',     label_en:'dreamy' },
  { key:'calm',      label_ko:'í‰ì˜¨í•œ',         label_en:'calm' },
  { key:'sad',       label_ko:'ìŠ¬í”ˆ',           label_en:'sad' },
  { key:'love',      label_ko:'ì‚¬ë‘ì— ë¹ ì§„',     label_en:'in love' },
];
const EXT = "mp3";
const COUNT = 10;
const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyowrSqY3hw71XR7qIqzAHyhm4iUnh27x-Q9qW3zmvboKudPemd3OQLLIaIs2SmX0XP/exec";

/* ì°¸ê°€ì ê´€ë ¨ ì „ì—­ (ë¡± í¬ë§·ìš©) */
let PARTICIPANT_GROUP = null;
let PARTICIPANT_ID = `P${Date.now()}_${Math.floor(Math.random()*1e6)}`;
let ALL_ROWS = [];

/* ===== jsPsych ===== */
const jsPsych = initJsPsych({ display_element: "jspsych-target" });
jsPsych.data.addProperties({ participant_id: PARTICIPANT_ID });

const timeline = [];

/* ===== ì „ê³µ ì—¬ë¶€ ì§ˆë¬¸ (ìˆ˜ì •ì‚¬í•­3) ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>ì‹œì‘í•˜ê¸° ì „</h2>
    <p>ë³¸ì¸ì˜ ì „ê³µ ì—¬ë¶€ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
  `,
  choices: ["ìŒì•… ì „ê³µ", "ìŒì•… ë¹„ì „ê³µ"],
  on_finish: (data) => {
    const group = data.response === 0 ? "music_major" : "non_music_major";
    PARTICIPANT_GROUP = group;
    jsPsych.data.addProperties({ participant_group: group });
  }
});

/* ===== ì•ˆë‚´ ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <h2>ê°ì •ë³„ 5ì  ì²™ë„ í‰ê°€ ì‹¤í—˜</h2>
    <div class="note">
      <ul style="margin:0 0 8px 16px;">
        <li>ê°ì • ìˆœì„œëŠ” ë¬´ì‘ìœ„ì…ë‹ˆë‹¤. ê° ê°ì •ë§ˆë‹¤ 10ê³¡ì´ ì œì‹œë©ë‹ˆë‹¤.</li>
        <li>ê° ê³¡ì€ ì›í•˜ëŠ” ë§Œí¼ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ê° ê³¡ì´ í•´ë‹¹ ê°ì •ì— <b>ì–¼ë§ˆë‚˜ ì ì ˆí•œì§€</b> 1~5ì ìœ¼ë¡œ í‰ê°€í•´ ì£¼ì„¸ìš”.</li>
        <li>(<b>1=ë¶€ì ì ˆí•¨</b> â€¦ <b>5=ì ì ˆí•¨</b>)</li>
      </ul>
    </div>
  `,
  choices: ["ì‹œì‘í•˜ê¸°"]
});

/* ===== ê°ì • ë¸”ë¡ (5ì  ì²™ë„) ===== */
function buildBlock(emotion){
  // ê³¡ ì •ë³´ ë°°ì—´ ìƒì„±
  const items = Array.from({length:COUNT}, (_,i) => {
    const idx = i + 1;
    const path = `${ROOT}/${emotion.key}/${emotion.key}${idx}.${EXT}`;
    return {
      id: i,                          // ê³ ì • ID (0~COUNT-1)
      index_in_emotion: idx,          // ê°ì • ë‚´ ë²ˆí˜¸ (1~COUNT)
      path: path,
      file_name: `${emotion.key}${idx}.${EXT}`,
      file_path: path
    };
  });

  // í•œ ê°ì • ì•ˆì—ì„œ ê³¡ ìˆœì„œ ëœë¤
  const shuffled = items.slice().sort(() => Math.random() - 0.5);

  return [{
    type: jsPsychHtmlButtonResponse,
    data: { emotion: emotion.key },
    stimulus: () => {
      const others = EMOTIONS
        .filter(e => e.key !== emotion.key)
        .map(e => `'${e.label_ko}'`)
        .join(", ");

      const cards = shuffled.map((item, idx) => `
        <div class="audio-card" data-item-id="${item.id}">
          <div class="note">
            <p style="margin:0 0 4px 0;"><b>&lt;íŒë‹¨ ê¸°ì¤€&gt;</b></p>
            <ol style="margin:0 0 0 16px; padding-left:16px;">
              <li>â€œ<b>${emotion.label_ko}</b>â€ ê°ì •ì„ ì˜ í‘œí˜„í•˜ê³  ìˆëŠ”ê°€?</li>
              <li>ì´ ê³¡ì„ ë“¤ì—ˆì„ ë•Œ ë‹¤ë¥¸ ê°ì •(${others}) 6ê°œì™€ í—·ê°ˆë¦¬ì§€ ì•Šê³  '<b>${emotion.label_ko}</b>'ë¥¼ ì„ íƒí•  ìˆ˜ ìˆì„ ë§Œí•œê°€?</li>
            </ol>
          </div>
          <div><b>ê³¡ ${idx+1}</b></div>
          <audio src="${item.path}" controls preload="metadata" playsinline></audio>
          <div class="scale" role="group" aria-label="ì ì ˆì„± 5ì  ì²™ë„">
            <span class="label muted">(ë¶€ì ì ˆí•¨)</span>
            <div class="nums">
              ${[1,2,3,4,5].map(v=>`<button class="score" data-score="${v}" type="button">${v}</button>`).join('')}
            </div>
            <span class="label muted">(ì ì ˆí•¨)</span>
          </div>
        </div>
      `).join("");

      return `
        <h3>${emotion.label_ko} <span class="muted">(${emotion.label_en})</span></h3>
        <p class="muted" id="remain">ë¯¸í‰ê°€ ê³¡: ${COUNT}</p>
        <div class="pair-wrap" id="pair-wrap">${cards}</div>
      `;
    },
    choices: ["í‰ê°€ ì™„ë£Œ"],
    on_load: () => {
      const wrap     = document.getElementById('pair-wrap');
      const btnGroup = document.getElementById('jspsych-html-button-response-btngroup');
      const doneBtn  = btnGroup ? btnGroup.querySelector('button') : null;
      const remainEl = document.getElementById('remain');
      const sel = {};  // item.id -> score

      function updateButton(){
        const remain = COUNT - Object.keys(sel).length;
        if(remainEl) remainEl.textContent = `ë¯¸í‰ê°€ ê³¡: ${remain}`;
        if(doneBtn){
          doneBtn.disabled = remain > 0;
          doneBtn.textContent = remain > 0 ? `í‰ê°€ ì™„ë£Œ (ë‚¨ì€ ${remain})` : 'í‰ê°€ ì™„ë£Œ';
        }
      }
      updateButton();

      // ì ìˆ˜ í´ë¦­ (ì»¨í…Œì´ë„ˆ ì´ë²¤íŠ¸ ìœ„ì„)
      if(wrap){
        wrap.addEventListener('click', (e)=>{
          const b = e.target.closest('button.score');
          if(!b) return;
          const card = b.closest('.audio-card');
          if(!card) return;
          const itemId = Number(card.dataset.itemId);
          const score  = Number(b.dataset.score);
          sel[itemId] = score;

          // ì„ íƒ í‘œì‹œ ê°±ì‹ 
          card.querySelectorAll('button.score').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');

          updateButton();
        }, { passive:true });

        // ë™ì‹œì— í•œ ê³¡ë§Œ ì¬ìƒ
        const auds = Array.from(wrap.querySelectorAll('audio'));
        auds.forEach(A => {
          A.addEventListener('play', () => {
            auds.forEach(B => {
              if(B !== A && !B.paused) B.pause();
            });
          });
        });
      }

      // ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì €ì¥
      window.__currentSel = sel;
      window.__currentItems = items;  // ì´ ë¸”ë¡ì˜ items ì •ë³´
    },
    on_finish: () => {
      const sel = window.__currentSel || {};
      const itemsRef = window.__currentItems || items;

      // sel: { itemId: score } â†’ long-format rows
      const rows = Object.entries(sel).map(([itemIdStr, score]) => {
        const itemId = Number(itemIdStr);
        const item = itemsRef[itemId];
        return {
          participant_id: PARTICIPANT_ID,
          participant_group: PARTICIPANT_GROUP,
          emotion_key: emotion.key,
          emotion_label_ko: emotion.label_ko,
          file_path: item.file_path,
          file_name: item.file_name,
          index_in_emotion: item.index_in_emotion,
          score: Number(score)
        };
      });

      // jsPsych trialì— ë©”íƒ€ ì €ì¥
      jsPsych.data.get().addToLast({
        allocations: sel,
        rows: rows
      });

      // ì „ì²´ rows ì „ì—­ ëˆ„ì 
      ALL_ROWS = ALL_ROWS.concat(rows);

      // ë¸”ë¡ ë‹¨ìœ„ ì—…ë¡œë“œëŠ” ìƒëµ (ëì—ì„œ í•œ ë²ˆë§Œ ë¡± í¬ë§· ì „ì†¡)
    }
  }];
}

/* ê°ì • ìˆœì„œ ë¬´ì‘ìœ„ */
const order = EMOTIONS.slice().sort(()=>Math.random()-0.5);
order.forEach(e => timeline.push(...buildBlock(e)));

/* ===== ì¢…ë£Œ ===== */
timeline.push({
  type: jsPsychHtmlButtonResponse,
  stimulus: `<h2>ê°ì‚¬í•©ë‹ˆë‹¤!</h2><p>ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`,
  choices: ["ë‹«ê¸°"],
  on_finish: () => {
    // ì „ì²´ ë¡± í¬ë§· ë°±ì—… (ìˆ˜ì •ì‚¬í•­2: long formatë§Œ ì „ì†¡)
    try{
      fetch(GS_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          kind: "cowen7_rating_full",   // ì˜ˆì „ê³¼ ë™ì¼í•œ kind ì´ë¦„ ì‚¬ìš©
          format: "long",               // (ì˜µì…˜) í˜•ì‹ í‘œì‹œìš©
          data: ALL_ROWS                // ğŸ”´ ë¡± í¬ë§·: ê° row = í•œ ìê·¹-í•œ ì ìˆ˜
        })
      });
    } catch(e) {
      console.warn("ì—…ë¡œë“œ ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):", e);
    }
  }
});

jsPsych.run(timeline);
</script>
</body>
</html>
